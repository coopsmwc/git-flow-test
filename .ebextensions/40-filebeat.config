files:
  "/etc/yum.repos.d/elastic.repo" :
    mode: "000660"
    owner: root
    group: root
    content: |
      [elastic-5.x]
      name=Elastic repository for 5.x packages
      baseurl=https://artifacts.elastic.co/packages/5.x/yum
      gpgcheck=1
      gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
      enabled=1
      autorefresh=1
      type=rpm-md


  "/etc/filebeat/filebeat.yml" :
    mode: "000600"
    owner: root
    group: root
    content: |
      ############################# Filebeat #####################################
      filebeat:
        prospectors:
          -
            paths:
              - /var/log/httpd/access_log
            fields:
              logzio_codec: plain
              token: `{"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "LOGZIO_TOKEN"}}`
              component: `{"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "APP_COMPONENT"}}`
              environment: `{"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "APP_ENV"}}`
            fields_under_root: true
            ignore_older: 3h
            document_type: aws_eb_apache_access
          -
            paths:
              - /var/log/httpd/error_log
            fields:
              logzio_codec: plain
              token: `{"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "LOGZIO_TOKEN"}}`
              component: `{"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "APP_COMPONENT"}}`
              environment: `{"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "APP_ENV"}}`
            fields_under_root: true
            ignore_older: 3h
            document_type: aws_eb_apache_error
          -
            paths:
              - /var/app/current/storage/logs/*.log
            fields:
              logzio_codec: plain
              token: `{"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "LOGZIO_TOKEN"}}`
              component: `{"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "APP_COMPONENT"}}`
              environment: `{"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "APP_ENV"}}`
            fields_under_root: true
            ignore_older: 3h
            document_type: laravel_app
            multiline:
              pattern: '^\[\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\]'
              negate: true
              match: after
          -
            paths:
              - /var/log/eb-activity.log
            fields:
              logzio_codec: plain
              token: `{"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "LOGZIO_TOKEN"}}`
              component: `{"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "APP_COMPONENT"}}`
              environment: `{"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "APP_ENV"}}`
            fields_under_root: true
            ignore_older: 3h
            document_type: aws_eb_activity
            multiline:
              pattern: '^\[\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z\]'
              negate: true
              match: after
        registry_file: /var/lib/filebeat/registry
      ############################# Output ##########################################
      output:
        logstash:
          hosts: ["listener-eu.logz.io:5015"]

      #########  The below configuration is used for Filebeat 1.3 or lower
          tls:
            certificate_authorities: ['/etc/pki/tls/certs/COMODORSADomainValidationSecureServerCA.crt']   
            
      ########  The below configuration is used for Filebeat 5.0 or higher      
          ssl:
            certificate_authorities: ['/etc/pki/tls/certs/COMODORSADomainValidationSecureServerCA.crt']
commands:
  "01":
    command: (cd /etc/pki/tls/certs && curl --remote-name https://raw.githubusercontent.com/logzio/public-certificates/master/COMODORSADomainValidationSecureServerCA.crt)
  "02":
    command: yum -y install filebeat

services:
  sysvinit:
    filebeat:
      enabled: "true"
      ensureRunning: "true"
    files:
      - "/etc/filebeat/filebeat.yml"

